/**
 * CLI for CVE Search
 */

import type { CLIOptions, Severity } from './types.js';

export function parseArgs(args: string[]): CLIOptions | null {
  const options: CLIOptions = {
    keyword: null,
    cveId: null,
    cweId: null,
    severity: null,
    days: null,
    limit: 10,
    apiKey: null,
    json: false,
  };

  for (let i = 0; i < args.length; i++) {
    const arg = args[i];

    switch (arg) {
      case '--keyword':
      case '-k':
        options.keyword = args[++i] || null;
        break;
      case '--cve':
        options.cveId = args[++i] || null;
        break;
      case '--cwe':
        options.cweId = args[++i] || null;
        break;
      case '--severity':
      case '-s': {
        const sev = args[++i]?.toUpperCase();
        if (sev && ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'].includes(sev)) {
          options.severity = sev as Severity;
        }
        break;
      }
      case '--days':
      case '-d': {
        const days = parseInt(args[++i], 10);
        if (!isNaN(days) && days > 0) {
          options.days = days;
        }
        break;
      }
      case '--limit':
      case '-l': {
        const limit = parseInt(args[++i], 10);
        if (!isNaN(limit) && limit > 0) {
          options.limit = limit;
        }
        break;
      }
      case '--api-key':
        options.apiKey = args[++i] || null;
        break;
      case '--json':
        options.json = true;
        break;
      case '--help':
      case '-h':
        printUsage();
        return null;
    }
  }

  return options;
}

export function validateOptions(options: CLIOptions): string | null {
  if (!options.keyword && !options.cveId && !options.cweId) {
    return 'At least one of --keyword, --cve, or --cwe is required';
  }
  return null;
}

function printUsage(): void {
  console.log(`
CVE Search - NVD API 2.0 Client

Usage:
  npx cve-search [options]

Options:
  --keyword, -k <term>    Search by keyword (software name, vendor)
  --cve <id>              Search by specific CVE ID (e.g., CVE-2021-44228)
  --cwe <id>              Filter by CWE ID (e.g., CWE-79)
  --severity, -s <level>  Filter by severity (CRITICAL, HIGH, MEDIUM, LOW)
  --days, -d <n>          Published in last N days
  --limit, -l <n>         Max results (default: 10)
  --api-key <key>         NVD API key (or set NVD_API_KEY env var)
  --json                  Output as JSON
  --help, -h              Show this help

Examples:
  npx cve-search --keyword "jquery"
  npx cve-search --cve "CVE-2021-44228"
  npx cve-search --cwe "CWE-89" --severity "CRITICAL"
  npx cve-search --keyword "apache" --days 30
  npx cve-search --keyword "react" --json
`);
}
